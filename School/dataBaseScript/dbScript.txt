USE [School]
GO
/****** Object:  StoredProcedure [dbo].[proc_PayTransaction_GetAll]    Script Date: 06/13/2016 13:08:29 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[proc_PayTransaction_GetAllByStudent]
	-- Add the parameters for the stored procedure here
	@studentId int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	Select 
			cast(p.yearFrom as char(4)) +  ' - ' + cast(p.yearTo as char(4)) PeriodYear,
			pgstc.payConfiguration,
			sum(pt.payAmount) TotalAmount,			
			spt.studentPayTransactionDescription,
			pgstc.periodGradeStudentId,
			rs.runScheduleDescription,
			pgstc.payConfiguration - SUM(pt.payAmount) restante,
			ptst.payTransactionStatusTypeDescription,
			tt.transactionTypeDescription
	 from dbo.PayTransaction pt inner join dbo.StudentPayTransaction spt
		on pt.studentPayTransactionId = spt.studentPayTransactionId inner join PeriodGradeStudentTranTypeConfiguration pgstc
		on spt.periodGradeStudentTranTypeConfigurationId = pgstc.periodGradeStudentTranTypeConfigurationId inner join PeriodGradeStudent pgs
		on pgstc.periodGradeStudentId = pgs.periodGradeStudentId inner join PeriodGradeGroup pgg
		on pgs.periodGradeGroupId = pgg.periodGradeGroupId inner join PeriodGrade pg
		on pgg.periodGradeId = pg.periodGradeId inner join Period p
		on pg.periodId = p.periodId inner join dbo.RunSchedule rs
		on pgstc.runScheduleId = rs.runScheduleId inner join dbo.StudentPayTransactionStatus spts
		on spt.studentPayTransactionId = spts.studentPayTransactionId inner join dbo.PayTransactionStatusType ptst
		on spts.payTransactionStatusTypeId = ptst.payTransactionStatusTypeId inner join TransactionType tt
		on pgstc.transactionTypeId = tt.transactionTypeId		
where pgs.studentId = 7
	and spts.toDate is null
group by pgstc.payConfiguration,
			spt.studentPayTransactionDescription,
			pgstc.periodGradeStudentId,p.yearFrom,p.yearTo,
			rs.runScheduleDescription,
			ptst.payTransactionStatusTypeDescription,
			tt.transactionTypeDescription
END
